import createFetchClient from "openapi-fetch";
import createClient from "openapi-react-query";
import type { paths } from "./api_stubs"; // generated by openapi-typescript

const fetchClient = createFetchClient<paths>({
  baseUrl: import.meta.env.BASE_URL,
  headers: { Accept: "application/json" },
});
const $api = createClient(fetchClient);

export const fetchLogs = async (workflow_id: string) => {
  const res = await fetchClient.GET("/api/workflows/{workflow_id}/logs", {
    params: { path: { workflow_id } },
    parseAs: "text",
  });
  return res.error ? "Failed to fetch logs." : res.data || "No logs.";
};

export const fetchOutput = async (
  workflow_id: string,
  node_location_str: string,
  port_name: string
) => {
  const res = await fetchClient.GET(
    "/api/workflows/{workflow_id}/nodes/{node_location_str}/outputs/{port_name}",
    {
      params: { path: { workflow_id, node_location_str, port_name } },
      parseAs: "text",
    }
  );
  return res.error ? "Failed to fetch output." : res.data;
};

export const fetchOutputs = async (
  workflow_id: string,
  node_location_str: string
) => {
  const res = await fetchClient.GET(
    "/api/workflows/{workflow_id}/nodes/{node_location_str}/outputs",
    {
      params: { path: { workflow_id, node_location_str } },
      parseAs: "text",
    }
  );
  return res.error ? "Failed to fetch output." : res.data;
};

export const fetchErrors = async (
  workflow_id: string,
  node_location_str: string
) => {
  const params = { path: { workflow_id, node_location_str } };
  const res = await fetchClient.GET(
    "/api/workflows/{workflow_id}/nodes/{node_location_str}/errors",
    { params, parseAs: "text" }
  );
  return res.data ?? "No errors.";
};

export const restartNode = async (
  workflow_id: string,
  node_location_str: string
): Promise<string[]> => {
  const params = { path: { workflow_id, node_location_str } };
  const res = await fetchClient.POST(
    "/api/workflows/{workflow_id}/nodes/{node_location_str}/restart",
    { params }
  );
  if (res.error) {
    console.log("Failed to restart node.");
    return [];
  }
  return res.data;
};

export const useWorkflowsQuery = () => $api.useQuery("get", "/api/workflows/");
export const useLogsQuery = (workflow_id: string) =>
  $api.useQuery("get", "/api/workflows/{workflow_id}/logs", {
    params: { path: { workflow_id } },
    parseAs: "text",
  });
export const useEvalQuery = (workflow_id: string, openEvals: string[]) =>
  $api.useQuery("get", "/api/workflows/{workflow_id}/graphs", {
    params: { path: { workflow_id }, query: { locs: openEvals } },
  });
